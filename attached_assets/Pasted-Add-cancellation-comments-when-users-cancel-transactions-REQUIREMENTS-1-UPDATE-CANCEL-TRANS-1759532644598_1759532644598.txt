Add cancellation comments when users cancel transactions:

REQUIREMENTS:

1. UPDATE CANCEL TRANSACTION MODAL

When user clicks "Cancel" on an offer/transaction, show enhanced modal:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cancel Your Offer?                          â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                             â”‚
â”‚ iPhone 15 Pro - $800                        â”‚
â”‚ Seller: Sarah Martinez                      â”‚
â”‚                                             â”‚
â”‚ Your $50 deposit will be:                   â”‚
â”‚ âœ… Fully refunded to you                    â”‚
â”‚ âœ… No penalties or fees                     â”‚
â”‚                                             â”‚
â”‚ âš ï¸ This cancellation will appear on your    â”‚
â”‚ public profile in transaction history.      â”‚
â”‚                                             â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                             â”‚
â”‚ Would you like to explain why?              â”‚
â”‚ (Optional, but recommended)                 â”‚
â”‚                                             â”‚
â”‚ Reason: [Select reason â–¼]                   â”‚
â”‚ Options:                                    â”‚
â”‚ - Found better deal                         â”‚
â”‚ - Personal/family emergency                 â”‚
â”‚ - Changed my mind                           â”‚
â”‚ - Item concerns from photos/description     â”‚
â”‚ - Scheduling conflict                       â”‚
â”‚ - Seller/Buyer unresponsive                 â”‚
â”‚ - Price too high                            â”‚
â”‚ - Other                                     â”‚
â”‚                                             â”‚
â”‚ Additional comment (optional):              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ I'm really sorry for the late         â”‚   â”‚
â”‚ â”‚ cancellation. My wife surprised me    â”‚   â”‚
â”‚ â”‚ with the same laptop as an early      â”‚   â”‚
â”‚ â”‚ birthday gift...                      â”‚   â”‚
â”‚ â”‚                                       â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ 145 / 500 characters                        â”‚
â”‚                                             â”‚
â”‚ â˜‘ï¸ Make this comment public                 â”‚
â”‚    (Recommended for transparency)           â”‚
â”‚                                             â”‚
â”‚ Note: Public comments help maintain your    â”‚
â”‚ reputation and show you communicate well.   â”‚
â”‚                                             â”‚
â”‚    [Cancel Transaction] [Keep Offer]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. API ENDPOINT

POST /api/transactions/:transactionId/cancel

Request body:
{
  cancelledBy: "buyer", // or "seller"
  reasonCategory: "found_better_deal",
  comment: "I'm really sorry for the late cancellation...",
  isPublic: true
}

Backend logic:
1. Update offer status to 'buyer_cancelled' or 'seller_cancelled'
2. Create record in cancellation_comments table:
   - transaction_id
   - cancelled_by_user_id
   - comment (text)
   - is_public (boolean)
   - cancelled_role ("buyer" or "seller")
   - cancellation_timing (calculate: "last_minute", "same_day", "one_day_before", etc.)
   - cancellation_reason_category
3. Update user_statistics (already done in Step 1)
4. Process deposit refund
5. Send email to other party

3. CALCULATE CANCELLATION TIMING

Based on scheduled meetup time:
- < 2 hours before: "last_minute"
- 2-6 hours before: "same_day"  
- 6-24 hours before: "one_day_before"
- 1-3 days before: "few_days_before"
- > 3 days before: "well_in_advance"

Store in cancellation_comments.cancellation_timing

4. DISPLAY IN TRANSACTION HISTORY

Update the transaction history page from Step 2:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âŒ CANCELLED BY BUYER - September 28, 2024 â”‚
â”‚                                             â”‚
â”‚ ğŸ’» MacBook Pro 16" - $2,200                â”‚
â”‚ Seller: David Chen â­ 4.9/5.0              â”‚
â”‚ [View David's reviews]                      â”‚
â”‚ Role: Buyer                                 â”‚
â”‚ Status: Cancelled 2 hours before meetup     â”‚
â”‚                                             â”‚
â”‚ ğŸ’¬ Your Cancellation Comment:               â”‚
â”‚ Reason: Personal emergency                  â”‚
â”‚                                             â”‚
â”‚ "I'm really sorry for the late             â”‚
â”‚  cancellation. My wife surprised me with   â”‚
â”‚  the same laptop as an early birthday      â”‚
â”‚  gift. I tried to cancel earlier but just  â”‚
â”‚  found out an hour ago. Again, my          â”‚
â”‚  apologies for any inconvenience."          â”‚
â”‚                                             â”‚
â”‚ Posted: Sep 28, 2024 at 2:15 PM             â”‚
â”‚                                             â”‚
â”‚ ğŸ’¬ David's Response:                        â”‚
â”‚ (Will be added in Step 4)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

If user didn't provide comment:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âŒ CANCELLED BY BUYER - July 30, 2024      â”‚
â”‚                                             â”‚
â”‚ ğŸ“± iPad Pro - $900                         â”‚
â”‚ Seller: Lisa Anderson â­ 4.6/5.0           â”‚
â”‚ Role: Buyer                                 â”‚
â”‚ Status: Cancelled 1 day after offer acceptedâ”‚
â”‚                                             â”‚
â”‚ ğŸ’¬ Cancellation Comment:                    â”‚
â”‚ No comment provided                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

5. DISPLAY ON PUBLIC PROFILE

On other users' profile pages (when viewing their history):

Show cancellations with comments when viewing someone else's profile:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ John Davis - Transaction History            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                             â”‚
â”‚ âŒ CANCELLED BY BUYER - September 28, 2024 â”‚
â”‚                                             â”‚
â”‚ MacBook Pro 16" - $2,200                    â”‚
â”‚ Role: Buyer                                 â”‚
â”‚                                             â”‚
â”‚ ğŸ’¬ John's Cancellation Comment:             â”‚
â”‚ Reason: Personal emergency                  â”‚
â”‚ "My wife surprised me with the same laptop  â”‚
â”‚  as a gift..."                              â”‚
â”‚                                             â”‚
â”‚ ğŸ’¬ Seller's Response:                       â”‚
â”‚ "Thanks for explaining! Congrats on gift!"  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

6. EMAIL NOTIFICATION

Send email to other party when cancellation happens:

Subject: Transaction Cancelled - [Item Name]

Hi [Name],

[User] has cancelled their offer/sale on:
[Item Name] - $[Price]

THEIR EXPLANATION:
"[Comment text or 'No comment provided']"

WHAT HAPPENS NOW:
âœ… Deposit refunded (if applicable)
âœ… Listing is available again
âœ… You can respond to their comment

[Respond to Comment]

This comment is now visible on their public profile.

- SellFast.now Team

7. EDGE CASES

Handle these scenarios:
- User cancels without comment â†’ Show "No comment provided"
- Comment is private (isPublic: false) â†’ Only show to involved parties
- Multiple cancellations â†’ Each has separate comment
- Very long comments â†’ Truncate with "Read more" after 200 chars

TESTING:

Test Case 1: Cancel with full comment
1. Accept an offer
2. Click "Cancel" 
3. Select reason: "Personal emergency"
4. Write comment: "My daughter broke her arm..."
5. Check "Make public"
6. Submit cancellation
7. Verify:
   - Offer status = 'buyer_cancelled'
   - Comment saved in database
   - Comment visible in transaction history
   - Email sent to other party

Test Case 2: Cancel with no comment
1. Cancel a transaction
2. Leave comment field empty
3. Submit
4. Verify transaction history shows "No comment provided"

Test Case 3: View someone else's cancellation
1. Navigate to another user's profile
2. Go to their transaction history
3. See their cancellation with comment
4. Verify comment is public and visible

Test Case 4: Private comment
1. Cancel with comment
2. Uncheck "Make public"
3. Verify only involved parties see comment
4. Other users see "No comment provided"

Test Case 5: Cancellation timing
1. Cancel 1 hour before meetup â†’ Shows "last_minute"
2. Cancel 1 day before â†’ Shows "one_day_before"
3. Cancel 5 days before â†’ Shows "well_in_advance"

Test Case 6: Email sent
1. Cancel with comment
2. Check other party receives email
3. Verify email contains comment text
4. Verify "Respond to Comment" link works

DELIVERABLES:
1. Enhanced cancellation modal with comment field
2. Reason dropdown with common options
3. Character counter (500 max)
4. Public/private toggle
5. API endpoint saving comments
6. Comments display in transaction history
7. Cancellation timing calculation
8. Email notification sent
9. All test cases passing